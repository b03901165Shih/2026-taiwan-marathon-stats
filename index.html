<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <head>
  <title>2025-2026åŒ—éƒ¨é‡è¦é¦¬æ‹‰æ¾è³½äº‹ - åæ¬¡çµ±è¨ˆå·¥å…·</title>
  <meta name="description" content="å³æ™‚æŸ¥è©¢é¦¬æ‹‰æ¾å®Œè³½åˆ†å¸ƒã€42Kåæ¬¡æ’åã€å€‹äººæˆç¸¾åˆ†æã€‚æ”¯æ´å§“åã€åˆ†çµ„æœå°‹ã€‚">
  <meta name="keywords" content="é¦¬æ‹‰æ¾å®Œè³½åˆ†å¸ƒ,å®Œè³½æˆç¸¾,42Kåæ¬¡,21Kåæ¬¡,é¦¬æ‹‰æ¾æŸ¥è©¢">
  </head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI"; margin: 0; background: #f5f7fb; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { margin-bottom: 4px; }
    h2 { margin-top: 32px; }
    .card { background: #fff; border-radius: 16px; padding: 20px 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.07); margin-top: 16px; }
    .row { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
    select, input { padding: 8px 15px; font-size: 17px; border-radius: 8px; border: 1px solid #d1d5db; min-width: 120px; }
    button { padding: 8px 16px; border-radius: 8px; border: none; background: #2563eb; color: #fff; cursor: pointer; font-size: 17px; }
    button:hover { background: #1d4ed8; }
    .label { font-size: 17px; color: #555; min-width: 70px; }
    #chartContainer { height: 400px; }
    canvas { max-width: 100%; max-height: 100%; }
    .result-block { margin-top: 15px; padding: 15px 17px; border-radius: 10px; background: #f9fafb; border: 1px solid #e5e7eb; }
    .result-title { font-weight: 600; margin-bottom: 6px; color: #111827; }
    .result-line { font-size: 16px; color: #374151; }
    .result-line span.value { font-weight: 600; color: #111827; }
    .time-input-group { display: flex; align-items: center; gap: 4px; }
    .time-input-group input { width: 60px; text-align: center; }
    .pr-time { font-size: 18px; font-weight: 700; color: #059669; margin: 8px 0; }
    /* ç¾è§€è¡¨æ ¼æ¨£å¼ */
    table { 
      font-size: 17px; 
      width: 100%; 
      border-collapse: separate; 
      border-spacing: 0;
      margin-top: 15px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td { 
      padding: 10px 15px; 
      text-align: center; 
      border-bottom: 1px solid #e5e7eb; 
    }

    th { 
      font-weight: 600; 
      font-size: 1px; 
      color: #1f2937; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom: 2px solid #e2e8f0;
    }

    td { 
      color: #374151; 
      background: #ffffff;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover { 
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    td:nth-child(2), td:nth-child(3), td:nth-child(4), td:nth-child(5) {
      text-align: center; 
      font-weight: 500;
    }

    /* æ•¸å­—é«˜äº® */
    td:nth-child(4) { /* PR æ¬„ */
      color: #059669;
      font-weight: 600;
    }

  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸƒâ€â™‚ï¸ 2026 åŒ—éƒ¨é‡è¦é¦¬æ‹‰æ¾è³½äº‹ - åæ¬¡çµ±è¨ˆå·¥å…·</h1>
  <div style="color:#6b7280;font-size:17px;">æˆç¸¾ä¾†æº: Brav elog. ä»¥å¤§æœƒæˆç¸¾(Official Time)ç‚ºæº–.</div>

  <!-- æ–°è³‡æ–™è¼‰å…¥ï¼šæ”¯æ´ç„¡é™è³½äº‹æ“´å……ï¼ -->
  <script src="2025_tpe_data.js"></script>
  <script src="2026_chartered_tpe_data.js"></script>

  <!-- å€å¡Š 1ï¼šäº’å‹•å¼ histogram -->
  <h2>1. åˆ†çµ„å®Œè³½æ™‚é–“åˆ†å¸ƒ (histogram)</h2>
  <div class="card">
    <div class="row">
      <div class="label">è³½äº‹ï¼š</div>
      <select id="eventSelect"></select>

      <div class="label">è³½åˆ¥ï¼š</div>
      <select id="raceSelect"></select>

      <div class="label">åˆ†çµ„ï¼š</div>
      <select id="groupSelect"></select>
    </div>
    <div id="chartContainer">
      <canvas id="histCanvas"></canvas>
    </div>
  </div>

  <!-- å€å¡Š 2ï¼šè¼¸å…¥æ™‚é–“ â†’ æŸ¥ç¸½å ´ & æ€§åˆ¥ & ç´°éƒ¨åˆ†çµ„æ’å/PR -->
  <h2>2. è¼¸å…¥æ™‚é–“ï¼ŒæŸ¥ç¸½å ´ / æ€§åˆ¥ / åˆ†çµ„æ’å & PR</h2>
  <div class="card">
    <div class="row">
      <div class="label">è³½äº‹ï¼š</div>
      <select id="eventForPr"></select>

      <div class="label">è³½åˆ¥ï¼š</div>
      <select id="raceForPr"></select>

      <div class="label">åˆ†çµ„é¡å‹ï¼š</div>
      <select id="groupForPr"></select>
    </div>

    <div class="row">
      <div class="label">å®Œè³½æ™‚é–“ï¼š</div>
      <div class="time-input-group">
        <input id="hInput" type="number" min="0" max="23" placeholder="HH"> :
        <input id="mInput" type="number" min="0" max="59" placeholder="MM"> :
        <input id="sInput" type="number" min="0" max="59" placeholder="SS">
      </div>
      <button id="btnCheckPr">æŸ¥è©¢æ’å / PR</button>
    </div>

    <div id="prResultArea"></div>
  </div>

  <!-- å€å¡Š 3ï¼šè¼¸å…¥ PR å€¼ â†’ æŸ¥å‰›å¥½è¶…è¶Šçš„æ™‚é–“ -->
  <h2>3. è¼¸å…¥ PR å€¼ï¼ŒæŸ¥å‰›å¥½è¶…è¶Šçš„æ™‚é–“</h2>
  <div class="card">
    <div class="row">
      <div class="label">è³½äº‹ï¼š</div>
      <select id="eventForPrReverse"></select>

      <div class="label">è³½åˆ¥ï¼š</div>
      <select id="raceForPrReverse"></select>

      <div class="label">åˆ†çµ„ï¼š</div>
      <select id="groupForPrReverse">
        <!-- å‹•æ…‹å¡«å…¥ ALL / å„ç´°åˆ†çµ„ -->
      </select>
    </div>

    <div class="row">
      <div class="label">PR å€¼ï¼š</div>
      <input id="prInput" type="number" min="0" max="100" step="0.1" placeholder="0 ~ 100">
      <button id="btnCheckPrReverse">æŸ¥è©¢å°æ‡‰æ™‚é–“</button>
    </div>

    <div id="prReverseResultArea"></div>
  </div>

</div>

<script>
  // ğŸŒŸ æ–°æ¶æ§‹ï¼šè‡ªå‹•åµæ¸¬æ‰€æœ‰è³½äº‹ï¼
  let marathonData = window.marathonData || {};
  let raceHierarchy = {};
  let histChart = null;

  // ---------- ğŸ”§ æ ¸å¿ƒå·¥å…·å‡½å¼ï¼ˆæ”¹é€²ç‰ˆï¼‰ ----------
  function getAllEvents() {
    return Object.keys(window.marathonData).map(id => window.marathonData[id].metadata);
  }

  function getEventData(eventId) {
    return window.marathonData[eventId];
  }

  function getEventIdFromName(eventName) {
    return getAllEvents().find(e => e.event_name === eventName)?.event_id;
  }

  // âœ… ä¿®å¾©ï¼šæ­£ç¢ºè§£æå®Œæ•´ key
  function parseFullKey(fullKey) {
    // ğŸ¯ æ–°æ ¼å¼ï¼ševentId__raceType__group ï¼ˆä¸‰å€‹ __ï¼‰
    // ç¯„ä¾‹ï¼š
    // "2025_tpe__HM__ç”·è¦–éšœé¸æ‰‹"           â†’ {eventId: "2025_tpe", raceType: "HM", group: "ç”·è¦–éšœé¸æ‰‹"}
    // "2026_chartered_tpe__å…¨ç¨‹é¦¬æ‹‰æ¾(42.195KM)__ç”·60æ­²+" â†’ {eventId: "2026_chartered_tpe", raceType: "å…¨ç¨‹é¦¬æ‹‰æ¾(42.195KM)", group: "ç”·60æ­²+"}
    
    const parts = fullKey.split('__', 3);
    if (parts.length !== 3) {
      console.error("âŒ Key æ ¼å¼éŒ¯èª¤ï¼Œå¿…é ˆæœ‰å…©å€‹ __ åˆ†éš”ï¼š", fullKey);
      return null;
    }
    
    const eventId = parts[0];   // 2025_tpe
    const raceType = parts[1];  // HM æˆ– å…¨ç¨‹é¦¬æ‹‰æ¾(42.195KM)
    const group = parts[2];     // ç”·è¦–éšœé¸æ‰‹ æˆ– ç”·60æ­²+
    
    return { eventId, raceType, group };
  }


  // âœ… ç”¢ç”Ÿå®Œæ•´ key
  function getFullKey(eventId, raceType, group) {
    // ç”¢ç”Ÿæ–°æ ¼å¼ï¼ševentId__raceType__group
    return `${eventId}__${raceType}__${group}`;
  }
  // ---------- å°å·¥å…· ----------
  function classifyGroup(rawGroup) {
    const g = String(rawGroup);
    if (g.includes("è¼ªæ¤…")) return "è¼ªæ¤…";
    if (g.includes("è¦–éšœ")) return "è¦–éšœ";
    return "ä¸€èˆ¬";
  }

  function secondsToTime(sec) {
    sec = Math.floor(sec);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function timeToSeconds(h, m, s) {
    return h*3600 + m*60 + s;
  }

  function parseTimeInputs() {
    const h = parseInt(document.getElementById("hInput").value, 10);
    const m = parseInt(document.getElementById("mInput").value, 10);
    const s = parseInt(document.getElementById("sInput").value, 10);
    if (Number.isNaN(h) || Number.isNaN(m) || Number.isNaN(s)) {
      alert("è«‹è¼¸å…¥å®Œæ•´çš„ HH:MM:SS");
      return null;
    }
    if (h < 0 || h > 23 || m < 0 || m > 59 || s < 0 || s > 59) {
      alert("æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªåœ¨ 00:00:00 ~ 23:59:59 ä¹‹é–“");
      return null;
    }
    return timeToSeconds(h, m, s);
  }

  // binary searchï¼šå·²æ’åºé™£åˆ— arr (ç”±å°åˆ°å¤§)ï¼Œå°‹æ‰¾ first index ä½¿å¾— arr[idx] >= target
  function lowerBound(arr, target) {
    let lo = 0, hi = arr.length;
    while (lo < hi) {
      const mid = (lo + hi) >> 1;
      if (arr[mid] < target) {
        lo = mid + 1;
      } else {
        hi = mid;
      }
    }
    return lo;
  }

  // ---------- ğŸ—ï¸ è‡ªå‹•å»ºç«‹éšå±¤çµæ§‹ ----------
  function buildRaceHierarchy() {
    raceHierarchy = {};
    
    getAllEvents().forEach(event => {
      const eventId = event.event_id;
      const eventName = event.event_name;
      raceHierarchy[eventName] = {};
      
      const data = getEventData(eventId);
      if (!data?.binsAndPr) return;
      
      Object.keys(data.binsAndPr).forEach(fullKey => {
        const parsed = parseFullKey(fullKey);
        if (!parsed) return;
        
        const { raceType, group } = parsed;
        if (!raceHierarchy[eventName][raceType]) {
          raceHierarchy[eventName][raceType] = new Set();
        }
        raceHierarchy[eventName][raceType].add(group);
      });
      
      // æ’åºåˆ†çµ„
      Object.keys(raceHierarchy[eventName]).forEach(raceType => {
        const groups = Array.from(raceHierarchy[eventName][raceType]);
        groups.sort((a, b) => a === "ALL" ? -1 : (b === "ALL" ? 1 : a.localeCompare(b, "zh-Hant")));
        raceHierarchy[eventName][raceType] = groups;
      });
    });
    
    console.log("ğŸ—ï¸ éšå±¤çµæ§‹ï¼š", raceHierarchy);
  }

  // ---------- ğŸ›ï¸ é¸æ“‡å™¨å¡«å…… ----------
  function fillEventSelects() {
    const events = getAllEvents();
    
    // åªå¡«å……è³½äº‹é¸å–®
    ["eventSelect", "eventForPr", "eventForPrReverse"].forEach(selectId => {
      const select = document.getElementById(selectId);
      if (!select) return;
      select.innerHTML = "";
      events.forEach(event => {
        const opt = document.createElement("option");
        opt.value = event.event_name;
        opt.textContent = event.event_name;
        opt.dataset.eventId = event.event_id;
        select.appendChild(opt);
      });
    });
    
    // âœ… ç¢ºä¿åˆ†çµ„é¡å‹é¸å–®æ°¸é æœ‰å€¼
    const groupForPr = document.getElementById("groupForPr");
    if (groupForPr && !groupForPr.querySelector('option')) {
      groupForPr.innerHTML = `
        <option value="ä¸€èˆ¬" selected>ä¸€èˆ¬</option>
        <option value="è¼ªæ¤…">è¼ªæ¤…</option>
        <option value="è¦–éšœ">è¦–éšœ</option>
      `;
    }
  }


  function updateRaceSelect(eventName, selectId) {
    const raceSelect = document.getElementById(selectId);
    if (!raceSelect) return;
    
    raceSelect.innerHTML = "";
    const raceTypes = Object.keys(raceHierarchy[eventName] || {}).sort();
    
    raceTypes.forEach(rt => {
      const opt = document.createElement("option");
      opt.value = rt;
      opt.textContent = rt;
      raceSelect.appendChild(opt);
    });
  }

  function updateGroupSelect(eventName, raceType, selectId) {
    const groupSelect = document.getElementById(selectId);
    if (!groupSelect) return;
    
    groupSelect.innerHTML = "";
    const groups = raceHierarchy[eventName]?.[raceType] || [];
    
    groups.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = (g === "ALL") ? "ALL (æ‰€æœ‰äºº)" : g;
      groupSelect.appendChild(opt);
    });
  }

  
  // âœ… **æ–°å¢ï¼šåˆ†çµ„é¡å‹é¸æ“‡å™¨**
  function updateGroupTypeSelect(eventName, raceType) {
    // groupForPr æ˜¯å›ºå®šçš„ï¼šä¸€èˆ¬/è¼ªæ¤…/è¦–éšœï¼Œä¸éœ€è¦æ›´æ–°
    console.log("åˆ†çµ„é¡å‹å·²é è¨­ï¼šä¸€èˆ¬/è¼ªæ¤…/è¦–éšœ");
  }
  
  // ğŸ“Š Histogram
  function drawHistogram() {
    const eventName = document.getElementById("eventSelect").value;
    const raceType = document.getElementById("raceSelect").value;
    const group = document.getElementById("groupSelect").value;
    
    if (!raceType || !group) {
      alert("è«‹å…ˆé¸æ“‡è³½åˆ¥å’Œåˆ†çµ„");
      return;
    }
    
    const eventSelect = document.getElementById("eventSelect");
    const eventId = eventSelect.selectedOptions[0].dataset.eventId;
    const fullKey = getFullKey(eventId, raceType, group);
    
    const eventData = getEventData(eventId);
    const obj = eventData?.binsAndPr?.[fullKey];
    
    if (!obj?.histogram_5min) {
      alert(`æ‰¾ä¸åˆ°è³‡æ–™ï¼š${eventName} / ${raceType} / ${group}`);
      return;
    }
    
    const bins = obj.histogram_5min;
    const labels = bins.map(b => b.start_time);
    const counts = bins.map(b => b.count);
    
    const ctx = document.getElementById("histCanvas").getContext("2d");
    if (histChart) histChart.destroy();
    
    histChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: `${eventName} / ${raceType} / ${group}`,
          data: counts,
          backgroundColor: "rgba(37,99,235,0.75)",
          borderColor: "rgba(30,64,175,1)",
          borderWidth: 1,
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const i = ctx.dataIndex;
                const b = bins[i];
                return [`äººæ•¸: ${b.count}`, `å€é–“: ${b.start_time} ~ ${b.end_time}`];
              }
            }
          }
        },
        scales: {
          x: { title: { display: true, text: "å®Œè³½æ™‚é–“ (5 åˆ†é˜å€é–“)" }, ticks: { maxRotation: 45, minRotation: 45 } },
          y: { beginAtZero: true, title: { display: true, text: "äººæ•¸" } }
        }
      }
    });
  }

  function lookupPrForTime() {
    const sec = parseTimeInputs();
    if (sec == null) return;

    const eventName = document.getElementById("eventForPr").value;
    const raceType = document.getElementById("raceForPr").value;
    const bucketType = document.getElementById("groupForPr").value;
    const eventSelect = document.getElementById("eventForPr");
    if (!eventSelect?.selectedOptions[0]?.dataset.eventId) {
      alert("è«‹å…ˆé¸æ“‡è³½äº‹");
      return;
    }
    
    const eventId = eventSelect.selectedOptions[0].dataset.eventId;
    const eventData = getEventData(eventId);
    const resultArea = document.getElementById("prResultArea");
    resultArea.innerHTML = "";

    if (!eventData?.binsAndPr) {
      resultArea.innerHTML = `<div class="result-block">æ‰¾ä¸åˆ°è³½äº‹è³‡æ–™</div>`;
      return;
    }

    // ğŸ”§ å®‰å…¨æ•¸å­—æ ¼å¼åŒ–å‡½å¼
    function safeLocale(n) {
      return (n || 0).toLocaleString();
    }

    console.log("ğŸ” è³½äº‹ID:", eventId);
    console.log("ğŸ” è³½åˆ¥:", raceType);
    console.log("ğŸ” æ‰€æœ‰ keys:", Object.keys(eventData.binsAndPr || {}));
    // 1) å…¨å ´ ALL âœ… å®‰å…¨æª¢æŸ¥
    const allKey = getFullKey(eventId, raceType, "ALL");
    const allObj = eventData.binsAndPr[allKey];
    
    console.log("ğŸ” é æœŸ ALL key:", allKey);
    console.log("ğŸ” ALL key å­˜åœ¨ï¼Ÿ", !!eventData.binsAndPr?.[allKey]);
    // åœ¨ lookupPrForTime() é–‹é ­åŠ å…¥ï¼š
    console.log("ğŸ” æª¢æŸ¥ ALL key:", allKey, "â†’", !!eventData.binsAndPr[allKey]);

    // éæ­·æ™‚åŠ å…¥ debugï¼š
    Object.keys(eventData.binsAndPr).forEach(fullKey => {
      const parsed = parseFullKey(fullKey);
      if (parsed && parsed.eventId === eventId && parsed.raceType === raceType) {
        console.log("âœ… æ‰¾åˆ°åŒ¹é…åˆ†çµ„:", parsed.group, classifyGroup(parsed.group));
      }
    });
    
    
    if (allObj?.sorted_seconds?.length > 0) {
      const allArr = allObj.sorted_seconds;
      const N_all = allArr.length;
      const idxAll = lowerBound(allArr, sec);
      const rankAll = idxAll + 1;
      const slowerAll = Math.max(0, N_all - idxAll);
      const prAll = ((slowerAll / N_all) * 100).toFixed(2);

      const blockAll = document.createElement("div");
      blockAll.className = "result-block";
      blockAll.innerHTML = `
        <div class="result-title">${eventName} / ${raceType} / ALL (å…¨å ´)</div>
        <div class="result-line">ç¸½äººæ•¸ï¼š<span class="value">${safeLocale(N_all)}</span></div>
        <div class="result-line">ä½ çš„æ™‚é–“ï¼š<span class="value">${secondsToTime(sec)}</span></div>
        <div class="result-line">ç¸½å ´æ’åï¼š<span class="value">${safeLocale(rankAll)}</span></div>
        <div class="result-line">PR å€¼ï¼š<span class="value">${prAll}%</span>ï¼ˆè´é ${safeLocale(slowerAll)} äººï¼‰</div>
      `;
      resultArea.appendChild(blockAll);
    } else {
      const blockAll = document.createElement("div");
      blockAll.className = "result-block";
      blockAll.innerHTML = `<div class="result-title">${eventName} / ${raceType} / ALL</div><div class="result-line">ç„¡è³‡æ–™</div>`;
      resultArea.appendChild(blockAll);
    }

    // 2) æ€§åˆ¥å½™ç¸½ + ç´°åˆ†çµ„
    const maleArr = [], femaleArr = [], groupRows = [];

    Object.keys(eventData.binsAndPr).forEach(fullKey => {
      const parsed = parseFullKey(fullKey);
      
      // ğŸ”¥ é—œéµï¼šå…ˆç¯© ALLï¼Œå†ç¯© bucketType
      if (!parsed || parsed.eventId !== eventId || parsed.raceType !== raceType) return;
      if (parsed.group === "ALL") return;  // âœ… å…ˆç¯© ALL
      if (classifyGroup(parsed.group) !== bucketType) return;  // âœ… å†ç¯©åˆ†çµ„é¡å‹
      
      const obj = eventData.binsAndPr[fullKey];
      
      console.log(`ğŸ” åˆ†çµ„ ${parsed.group}:`, {
        hasSortedSeconds: !!obj?.sorted_seconds,
        length: obj?.sorted_seconds?.length,
        sample: obj?.sorted_seconds?.slice(0, 3)
      });
      
      if (!obj?.sorted_seconds || obj.sorted_seconds.length === 0) {
        console.log(`âŒ ${parsed.group} ç„¡ sorted_seconds è³‡æ–™`);
        return;
      }

      const arr = obj.sorted_seconds;
      const N = arr.length;
      
      if (parsed.group.includes("ç”·")) maleArr.push(...arr);
      else if (parsed.group.includes("å¥³")) femaleArr.push(...arr);

      const idx = lowerBound(arr, sec);
      const rank = idx + 1;
      const slower = Math.max(0, N - idx);
      const pr = (slower / N) * 100;
      
      groupRows.push({ groupName: parsed.group, rank, total: N, pr, slower });
    });

    // ç”·æ€§åˆè¨ˆ
    if (maleArr.length > 0) {
      maleArr.sort((a,b) => a-b);
      const N_m = maleArr.length;
      const idxM = lowerBound(maleArr, sec);
      const rankM = idxM + 1;
      const slowerM = Math.max(0, N_m - idxM);
      const prM = ((slowerM / N_m) * 100).toFixed(2);

      const blockM = document.createElement("div");
      blockM.className = "result-block";
      blockM.innerHTML = `
        <div class="result-title">${eventName} / ${raceType} / ${bucketType} / ç”·æ€§åˆè¨ˆ</div>
        <div class="result-line">ç¸½äººæ•¸ï¼š<span class="value">${safeLocale(N_m)}</span></div>
        <div class="result-line">æ’åï¼š<span class="value">${safeLocale(rankM)}</span></div>
        <div class="result-line">PR å€¼ï¼š<span class="value">${prM}%</span>ï¼ˆè´é ${safeLocale(slowerM)} äººï¼‰</div>
      `;
      resultArea.appendChild(blockM);
    }

    // å¥³æ€§åˆè¨ˆ
    if (femaleArr.length > 0) {
      femaleArr.sort((a,b) => a-b);
      const N_f = femaleArr.length;
      const idxF = lowerBound(femaleArr, sec);
      const rankF = idxF + 1;
      const slowerF = Math.max(0, N_f - idxF);
      const prF = ((slowerF / N_f) * 100).toFixed(2);

      const blockF = document.createElement("div");
      blockF.className = "result-block";
      blockF.innerHTML = `
        <div class="result-title">${eventName} / ${raceType} / ${bucketType} / å¥³æ€§åˆè¨ˆ</div>
        <div class="result-line">ç¸½äººæ•¸ï¼š<span class="value">${safeLocale(N_f)}</span></div>
        <div class="result-line">æ’åï¼š<span class="value">${safeLocale(rankF)}</span></div>
        <div class="result-line">PR å€¼ï¼š<span class="value">${prF}%</span>ï¼ˆè´é ${safeLocale(slowerF)} äººï¼‰</div>
      `;
      resultArea.appendChild(blockF);
    }
  
    // ç´°åˆ†çµ„è¡¨æ ¼ï¼ˆå®Œç¾ç‰ˆï¼‰
    const listBlock = document.createElement("div");
    listBlock.className = "result-block";
    const header = document.createElement("div");
    header.className = "result-title";
    header.textContent = `${eventName} / ${raceType} / ${bucketType} å„ç´°éƒ¨åˆ†çµ„`;
    listBlock.appendChild(header);

    if (groupRows.length === 0) {
      const line = document.createElement("div");
      line.className = "result-line";
      line.textContent = `æ­¤è³½åˆ¥ã€Œ${bucketType}ã€é¡å‹ç„¡è³‡æ–™`;
      listBlock.appendChild(line);
    } else {
      groupRows.sort((a, b) => a.groupName.localeCompare(b.groupName, "zh-Hant"));
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th style="text-align:left;padding:12px 15px;font-weight:700;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);color:#1f2937;border-bottom:2px solid #e2e8f0;font-size:17px;">åˆ†çµ„</th>
            <th style="padding:12px 15px;font-weight:700;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);color:#1f2937;border-bottom:2px solid #e2e8f0;font-size:17px;">æ’å</th>
            <th style="padding:12px 15px;font-weight:700;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);color:#1f2937;border-bottom:2px solid #e2e8f0;font-size:17px;">ç¸½äººæ•¸</th>
            <th style="padding:12px 15px;font-weight:700;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);color:#1f2937;border-bottom:2px solid #e2e8f0;font-size:17px;">PR</th>
            <th style="padding:12px 15px;font-weight:700;background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);color:#1f2937;border-bottom:2px solid #e2e8f0;font-size:17px;">è´éäººæ•¸</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      
      const tbody = table.querySelector("tbody");
      groupRows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="text-align:left;padding:10px 15px;">${r.groupName}</td>
          <td style="padding:10px 15px;text-align:center;font-weight:500;">${safeLocale(r.rank)}</td>
          <td style="padding:10px 15px;text-align:center;font-weight:500;">${safeLocale(r.total)}</td>
          <td style="padding:10px 15px;text-align:center;color:#059669;font-weight:600;">${r.pr.toFixed(2)}%</td>
          <td style="padding:10px 15px;text-align:center;font-weight:500;">${safeLocale(r.slower)}</td>
        `;
        tbody.appendChild(tr);
      });
      
      // ğŸ”¥ åŠ ä¸Š hover å‹•ç•«
      table.style.cssText = `
        width: 100%; 
        border-collapse: collapse; 
        border-radius: 8px; 
        overflow: hidden; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        font-size: 17px;
      `;
      
      listBlock.appendChild(table);
    }
    resultArea.appendChild(listBlock);

  }


  // â±ï¸ PRåæŸ¥
  function lookupTimeForPr() {
    const prPct = parseFloat(document.getElementById("prInput").value);
    if (isNaN(prPct) || prPct < 0 || prPct > 100) {
      alert("è«‹è¼¸å…¥ 0 ~ 100 ä¹‹é–“çš„ PR å€¼");
      return;
    }

    const eventName = document.getElementById("eventForPrReverse").value;
    const raceType = document.getElementById("raceForPrReverse").value;
    const group = document.getElementById("groupForPrReverse").value;
    const eventId = document.getElementById("eventForPrReverse").selectedOptions[0].dataset.eventId;
    const fullKey = getFullKey(eventId, raceType, group);
    const eventData = getEventData(eventId);
    const obj = eventData.binsAndPr[fullKey];
    const resultArea = document.getElementById("prReverseResultArea");
    resultArea.innerHTML = "";

    if (!obj?.sorted_seconds) {
      resultArea.innerHTML = `<div class="result-block">æ‰¾ä¸åˆ° ${fullKey} çš„è³‡æ–™</div>`;
      return;
    }

    const sortedSeconds = obj.sorted_seconds;
    const N = sortedSeconds.length;
    if (N === 0) {
      resultArea.innerHTML = `<div class="result-block">æ­¤çµ„åˆ¥ç„¡å®Œè³½è³‡æ–™</div>`;
      return;
    }

    const slowerCount = Math.floor((prPct / 100) * N);
    const targetRank = N - slowerCount;
    
    if (targetRank > N) {
      resultArea.innerHTML = `
        <div class="result-block">
          <div class="result-title">${eventName} / ${raceType} / ${group}</div>
          <div class="result-line">ç¸½äººæ•¸ï¼š<span class="value">${N.toLocaleString()}</span></div>
          <div class="pr-time">æ­¤ PR (${prPct}%) éœ€è¦ç¬¬ ${targetRank} åï¼Œä½†åªæœ‰ ${N} äººï¼Œç„¡æ³•é”æˆï¼</div>
        </div>
      `;
      return;
    }

    const targetTimeSec = sortedSeconds[targetRank - 1];
    const targetTimeStr = secondsToTime(targetTimeSec);

    const block = document.createElement("div");
    block.className = "result-block";
    block.innerHTML = `
      <div class="result-title">${eventName} / ${raceType} / ${group}</div>
      <div class="result-line">ç¸½äººæ•¸ï¼š<span class="value">${N.toLocaleString()}</span></div>
      <div class="result-line">ç›®æ¨™æ’åï¼š<span class="value">${targetRank.toLocaleString()}</span> å</div>
      <div class="pr-time">â±ï¸ å‰›å¥½ ${prPct}% PR çš„æ™‚é–“ï¼š<span class="value">${targetTimeStr}</span></div>
      <div class="result-line">è´éï¼š<span class="value">${slowerCount.toLocaleString()}</span> äºº</div>
    `;
    resultArea.appendChild(block);
  }

  // ğŸš€ åˆå§‹åŒ–
  function init() {
    console.log("ğŸ“Š è¼‰å…¥è³½äº‹ï¼š", getAllEvents().map(e => e.event_name));
    buildRaceHierarchy();
    fillEventSelects();
      
    // ğŸ”¥ è¨­å®š3å€‹å€å¡Šé è¨­å€¼
    setDefaultForAllBlocks();
    // ğŸ”¥ Block1 è‡ªå‹•ç¹ªè£½ histogram
    drawHistogram();
  }

  function setDefaultForAllBlocks() {
    const events = getAllEvents();
    if (!events.length) return;
    
    const latestEventName = events[events.length - 1].event_name;
    const latestEventId = events[events.length - 1].event_id;
    
    // Block 1: Histogram
    setDefaultForBlock1(latestEventName, latestEventId);
    
    // Block 2: PRæŸ¥è©¢
    setDefaultForBlock2(latestEventName, latestEventId);
    
    // Block 3: PRåæŸ¥  
    setDefaultForBlock3(latestEventName, latestEventId);
  }

  function setDefaultForBlock1(eventName, eventId) {
    const eventSelect = document.getElementById("eventSelect");
    const raceSelect = document.getElementById("raceSelect");
    const groupSelect = document.getElementById("groupSelect");
    
    if (eventSelect) {
      eventSelect.value = eventName;
      eventSelect.selectedOptions[0].dataset.eventId = eventId;
    }
    
    // é¸æ“‡ç¬¬ä¸€å€‹å¯ç”¨è³½åˆ¥
    updateRaceSelect(eventName, "raceSelect");
    const firstRaceType = document.getElementById("raceSelect")?.value;
    if (firstRaceType && groupSelect) {
      updateGroupSelect(eventName, firstRaceType, "groupSelect");
    }
  }

  function setDefaultForBlock2(eventName, eventId) {
    const eventSelect = document.getElementById("eventForPr");
    const raceSelect = document.getElementById("raceForPr");
    
    if (eventSelect) {
      eventSelect.value = eventName;
      eventSelect.selectedOptions[0].dataset.eventId = eventId;
      updateRaceSelect(eventName, "raceForPr");
    }
  }

  function setDefaultForBlock3(eventName, eventId) {
    const eventSelect = document.getElementById("eventForPrReverse");
    const raceSelect = document.getElementById("raceForPrReverse");
    const groupSelect = document.getElementById("groupForPrReverse");
    
    if (eventSelect) {
      eventSelect.value = eventName;
      eventSelect.selectedOptions[0].dataset.eventId = eventId;
      updateRaceSelect(eventName, "raceForPrReverse");
    }
    
    const firstRaceType = document.getElementById("raceForPrReverse")?.value;
    if (firstRaceType && groupSelect) {
      updateGroupSelect(eventName, firstRaceType, "groupForPrReverse");
    }
  }

    // äº‹ä»¶ç›£è½å™¨// Block1 è‡ªå‹•æ›´æ–°ï¼ˆé¸å–®è®Šæ›´å³æ™‚ç¹ªåœ–ï¼‰
  document.getElementById("eventSelect").addEventListener("change", function(e) {
    const eventName = e.target.value;
    updateRaceSelect(eventName, "raceSelect");
    drawHistogram(); // è‡ªå‹•ç¹ªåœ–
  });

  document.getElementById("raceSelect").addEventListener("change", function(e) {
    const eventName = document.getElementById("eventSelect").value;
    const raceType = e.target.value;
    updateGroupSelect(eventName, raceType, "groupSelect");
    drawHistogram(); // è‡ªå‹•ç¹ªåœ–
  });

  document.getElementById("groupSelect").addEventListener("change", function() {
    drawHistogram(); // åˆ†çµ„è®Šæ›´ä¹Ÿè‡ªå‹•ç¹ªåœ–
  });

  document.getElementById("eventForPr").addEventListener("change", (e) => {
    const eventName = e.target.value;
    updateRaceSelect(eventName, "raceForPr");
  });
  document.getElementById("raceForPr").addEventListener("change", (e) => {
    const eventName = document.getElementById("eventForPr").value;
    updateGroupTypeSelect(eventName, e.target.value);
  });
  document.getElementById("btnCheckPr").addEventListener("click", lookupPrForTime);

  document.getElementById("eventForPrReverse").addEventListener("change", (e) => {
    updateRaceSelect(e.target.value, "raceForPrReverse");
    const raceType = document.getElementById("raceForPrReverse").value;
    if (raceType) updateGroupSelect(e.target.value, raceType, "groupForPrReverse");
  });
  document.getElementById("raceForPrReverse").addEventListener("change", (e) => {
    const eventName = document.getElementById("eventForPrReverse").value;
    updateGroupSelect(eventName, e.target.value, "groupForPrReverse");
  });
  document.getElementById("btnCheckPrReverse").addEventListener("click", lookupTimeForPr);



  window.addEventListener("DOMContentLoaded", function() {
    init();
  });
</script>
</body>